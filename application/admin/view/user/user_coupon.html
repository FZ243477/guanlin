<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{:getSetting('system.title')} </title>

    <link href="home_url/css/bootstrap.min.css" rel="stylesheet">
    <link href="home_url/css/font-awesome.css-v=4.4.0.css" rel="stylesheet">
    <link href="home_url/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="home_url/css/style.min.css" rel="stylesheet">
    <link href="home_url/css/common.css" rel="stylesheet">

</head>

{include file="base:base" /}
<body class="gray-bg">
<div id="app" v-cloak>
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox">
                    <div class="tabs-container">

                        <div class="tab-content">
                            <div id="tab-1" class="tab-pane active">
                                <div class="panel-body">

                                    <div class="ibox-content-del">
                                        <div class="row">
                                            <div class="tables-searchbox newcearchbox">
                                                <div class="form_left">
                                                    <input type="text" placeholder="优惠券名称" class="input-sm form-control" name="keyword" value="">
                                                </div>
                                                <div class="form_left">
                                                    <input type="text"  name="start_time" id="start" class="input-sm form-control"  value="" placeholder="开始时间" class="input Wdate mini" style="border-color:#ccc" autocomplete="off">
                                                </div>
                                                <div class="form_left">
                                                    <span class="mgr5">至</span>
                                                </div>
                                                <div class="form_left">
                                                    <input type="text"  name="end_time" id="end" class="input-sm form-control" value="" placeholder="结束时间" class="input Wdate mini" style="border-color:#ccc" autocomplete="off">
                                                </div>
                                                <button class="btn btn-primary input-sm line_h10" @click="msgListView(1, 1)"><i class="gicon-search white"></i>查询</button>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover products_table">
                                                <colgroup>
                                                    <col width="5%">
                                                    <col width="5%">
                                                    <col width="10%">
                                                    <col width="10%">
                                                    <col width="10%">
                                                    <col width="10%">
                                                    <col width="10%">
                                                    <col width="10%">

                                                </colgroup>
                                                <thead>

                                                <tr >
                                                    <th></th>
                                                    <th>优惠码</th>
                                                    <th>优惠券名称</th>
                                                    <th>类型</th>
                                                    <th>限制条件</th>
                                                    <th>金额/折扣</th>
                                                    <th>开始时间</th>
                                                    <th>结束时间</th>

                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr  v-for="(vo, key) in list">
                                                    <td>
                                                        <input type="checkbox" class="i-checks checkbox" name="input" :value="vo.id">
                                                    </td>
                                                    <td>{{vo.coupon_no}}</td>
                                                    <td>{{vo.title}}</td>
                                                    <td>{{vo.coupontype_name}}</td>
                                                    <td>满{{vo.limit_money}}元使用</td>
                                                    <td>{{vo.price}}</td>
                                                    <td>{{vo.starttime}}</td>
                                                    <td>{{vo.endtime}}</td>
                                                </tr>
                                                <tr v-if="list == ''"><td style='text-align:center' colspan='8'>暂无数据</td></tr>
                                                <tr>
                                                    <td colspan="12" class="pro_lasttd">
                                                        <label ><input type="checkbox" class="i-checks all"  name="inputs"><span>全选</span></label>

                                                        <div class="pro_table_contro">
                                                            <a href="javascript:void(0);" class="btn btn-primary " @click="userCouponSend()" >确认发放</a>
                                                        </div>

                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>

                                            <div class="text-center">
                                                <div class="page" v-if="pageInfo.pageCount > 1">
                                                    <navigation  v-if="hackReset" :pages="pageInfo.pageCount" :current="pageInfo.pageCurrent"  @navpage="msgListView"></navigation>
                                                </div>
                                            </div>

                                        </div>

                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<script src="home_url/js/jquery.min.js"></script>
<script src="home_url/js/bootstrap.min.js"></script>
<script src="home_url/js/plugins/peity/jquery.peity.min.js"></script>
<script src="home_url/js/content.min.js"></script>
<script src="home_url/js/plugins/iCheck/icheck.min.js"></script>
<script src="home_url/js/peity-demo.min.js"></script>
<script src="home_url/js/plugins/layer/laydate/laydate.js"></script>
<script src="home_url/js/plugins/layer/layer.min.js"></script>
<script type="text/javascript">

    $(document).ready(function () {

        $('td.pro_lasttd input').on('ifChecked', function(event){
            $('input').iCheck('check');
        });
        $('td.pro_lasttd input').on('ifUnchecked', function(event){
            $('input').iCheck('uncheck');
        });

        $(".admin_li_b1").click(function(){
            var edit=$(this).parent(".admin_li_btn").siblings(".admin_li_edit");
            $(".admin_li_edit").not(edit).hide();
            edit.toggle();
        })

        function stopPropagation(e) {
            if (e.stopPropagation)
                e.stopPropagation();
            else
                e.cancelBubble = true;
        }
        $(document).bind('click',function(){
            $(".admin_li_edit").hide();
        });

        $(".admin_li_edit").bind('click',function(e){
            stopPropagation(e);
        });
        $(".admin_li_b1").bind('click',function(e){
            stopPropagation(e);
        });


        $("li.admin_li").click(function(){
            $(this).addClass("active").siblings("li.admin_li").removeClass("active");
        })

        $(".admin_tree_top a.pull-right").click(function(){
            $(".admin-add-box").toggle();
        })
        $(".admin-add-box .btn-default").click(function(){
            $(".admin-add-box").hide();
        })

    });

    $("li").click(function(){
        $a=$(this).find("a").attr("href");
        // alert($a);
        if ($a) { window.location=$a; }
    })
</script>

<script src="home_url/js/vue/vue.min.js"></script>
<script src="home_url/js/vue/pagination.js"></script>
<script>
    var Url = window.location.protocol + '//' + window.location.host + '/admin';
    var s = window.location.href;
    console.log(s);
    var arr = s.split('id/');
    var id = arr[1];
    var app = new Vue({
        el: '#app',
        data: {
            list: [],
            pageInfo: {
                pageCurrent: 1, // 当前页
                pageCount: 1, // 总页数
                list_row: 10, // 当前条数
            },
            hackReset:true,
            is_button:0,
        },
        created: function(){ //获得初始数据
            var $_this = this
            // $_this.msgListView($_this.list1P.pageNo)
            // $_this.msgListView1($_this.list2P.pageNo)
            var post = {
                list_row: $_this.pageInfo.list_row, //每页数据个数
                page: $_this.pageInfo.pageCurrent, // 当前页
            };
            $.ajax({
                type: "POST",
                url: Url + '/User/userCoupon',
                data: post,
                dataType: 'json',
                success: function(data) {
                    $_this.list = data.data.list;
                    $_this.pageInfo.pageCount = parseInt(data.data.pageCount) // 获取总页数
                    $_this.pageInfo.totalCount = parseInt(data.data.totalCount) // 是否显示分页器
                    $_this.$nextTick(function () {
                        var start = {
                            elem: "#start",
                            format: "YYYY-MM-DD",
                            max: laydate.now(),
                            min: "2000-01-01",
                            istime: true,
                            istoday: false,
                            choose: function (datas) {


                            }
                        };
                        var end = {
                            elem: "#end",
                            format: "YYYY-MM-DD",
                            max: laydate.now(),
                            min: "2000-01-01",
                            istime: true,
                            istoday: false,
                            choose: function (datas) {
                                start.max = datas
                            }
                        };
                        laydate(start);
                        laydate(end);

                        $(".checkbox").on('click', function (event) {
			var i = 1;
			$(".checkbox").each(function(){
				if(true != $(this).is(':checked')){
					i = 0;
				}
			});
			if (i == 1) {
				$('td.pro_lasttd input').prop('checked', true);
			} else {
				$('td.pro_lasttd input').prop('checked', false);
			}
		});
		$('td.pro_lasttd input').on('click', function(event){
			if(true == $(this).is(':checked')){
				$('.checkbox').prop('checked', true);
			} else {
				$('.checkbox').prop('checked', false);
			}
		});
                    })
                }
            })
        },
        mounted: function(){
            // 如在这里开始渲染地图!!! initMap()
        },
        methods: {
            msgListView: function(pageCurrent, is_button){ //搜索分页数据
                var $_this = this;
                var post = {
                    list_row: $_this.pageInfo.list_row, //每页数据个数
                    page: pageCurrent, // 当前页
                };

                if (is_button == 1) {
                    $_this.is_button = is_button;
                }
                if ($_this.is_button == 1) {
                    post.keyword = $('input[name="keyword"]').val();
                    post.start_time = $('input[name="start_time"]').val();
                    post.end_time = $('input[name="end_time"]').val();
                }
                $.ajax({
                    type:"POST",
                    url: Url + '/User/userCoupon',
                    data: post,
                    dataType:"json",
                    success:function(data){
                        $_this.list = data.data.list;
                        $_this.pageInfo.pageCount = parseInt(data.data.pageCount) // 获取总页数
                        $_this.pageInfo.totalCount = parseInt(data.data.totalCount) // 是否显示分页器
                        if (is_button == 1) {
                            $_this.hackReset = false;
                            $_this.$nextTick(function() {
                                $_this.hackReset = true
                            })
                        }
                        $_this.$nextTick(function () {
                            $(".checkbox").on('click', function (event) {
			var i = 1;
			$(".checkbox").each(function(){
				if(true != $(this).is(':checked')){
					i = 0;
				}
			});
			if (i == 1) {
				$('td.pro_lasttd input').prop('checked', true);
			} else {
				$('td.pro_lasttd input').prop('checked', false);
			}
		});
		$('td.pro_lasttd input').on('click', function(event){
			if(true == $(this).is(':checked')){
				$('.checkbox').prop('checked', true);
			} else {
				$('.checkbox').prop('checked', false);
			}
		});
                        })
                    }
                })
            },
            userCouponSend: function () {
                var $_this = this;
                var post = {};
                post.user_id = id;
                var ids = '';
                $(".checkbox").each(function(){
                    if(true == $(this).is(':checked')){
                        ids += ids?"-"+$(this).val():$(this).val();
                    }
                });

                if(!ids){
                    alert('请选择数据');
                    return false;
                }
                post.ids = ids;
                $.ajax({
                    type:"POST",
                    url: Url + '/User/userCouponSend',
                    data: post,
                    dataType:"json",
                    success:function(data){
                        javascript:window.parent.call_back(data);
                    }
                })
            },
        }
    })


</script>
</body>

</html>
